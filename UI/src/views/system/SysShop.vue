<template>
  <div class="app-container">
    <!--查询位置-->
    <el-form :model="queryParams" ref="queryForm" size="small" :inline="true" label-width="68px">
      <el-form-item label="关键词" prop="keyword">
        <el-input
                v-model="queryParams.keyword"
                placeholder="请输入关键词"
                clearable
                style="width: 240px"
                @keyup.enter.native="handleQuery"
        />
      </el-form-item>
      <el-form-item>
        <el-button type="primary" icon="el-icon-search" size="mini" @click="handleQuery">搜索</el-button>
        <el-button icon="el-icon-refresh" size="mini" @click="resetQuery">重置</el-button>
      </el-form-item>
    </el-form>

    <!--按钮位置-->
    <el-row :gutter="10" class="mb8" style="margin-bottom: 2px;">
      <el-col :span="1.5">
        <el-button
                type="primary"
                plain
                icon="el-icon-plus"
                size="mini"
                @click="handleAdd"
        >新增
        </el-button>
      </el-col>
      <el-col :span="1.5">
        <el-button
                type="danger"
                plain
                icon="el-icon-delete"
                size="mini"
                :disabled="multiple"
                @click="handleDelete"
        >删除
        </el-button>
      </el-col>
    </el-row>

    <!--列表-->
    <el-table :height="tableMaxHeight" stripe border v-loading="loading" :data="tableDataList"
              @selection-change="handleSelectionChange" ref="objectTable">
      <el-table-column type="selection" width="55" align="center"/>
      
          <el-table-column prop="shopName" :show-overflow-tooltip="true" width="150" label="商品名称">
          </el-table-column>

          <el-table-column prop="price" :show-overflow-tooltip="true" width="150" label="价格">
          </el-table-column>

          <el-table-column prop="stock" :show-overflow-tooltip="true" width="150" label="库存">
          </el-table-column>

          <el-table-column prop="describee" :show-overflow-tooltip="true" width="150" label="商品描述">
          </el-table-column>

      <el-table-column label="操作" align="center" class-name="small-padding fixed-width" fixed="right"
                       min-width="130">
        <template slot-scope="scope">
          <el-button
                  size="mini"
                  type="text"
                  icon="el-icon-edit"
                  @click="handleUpdate(scope.row)"
          >修改
          </el-button>
          <el-button
                  size="mini"
                  type="text"
                  icon="el-icon-delete"
                  @click="handleDelete(scope.row)"
          >删除
          </el-button>
          <el-button
              size="mini"
              type="text"
              icon="el-icon-s-goods"
              @click="handleBuy(scope.row)"
          >购买
          </el-button>
        </template>
      </el-table-column>
    </el-table>

    <!--购买界面-->
    <el-dialog title="新增" :visible.sync="orderFormVisible"  :close-on-click-modal="false">
      <el-form :model="orderForm" label-width="80px"  ref="addForm">
        <el-form-item label="商品名称" prop="shopName" >
          <el-input disabled v-model="orderForm.shopName" placeholder="商品名称" auto-complete="off" maxlength="50" show-word-limit style="width: 100%;"></el-input>
        </el-form-item>

        <el-form-item label="商品价格" prop="price" >
          <el-input  disabled v-model="orderForm.price" placeholder="商品价格" auto-complete="off" maxlength="50" show-word-limit style="width: 100%;"></el-input>
        </el-form-item>

        <el-form-item label="购买数量" prop="stock">
          <el-input-number v-model="orderForm.account"  :min="1" :max=max label="购买数量"></el-input-number>
<!--          <el-input v-model="orderForm.account" placeholder="购买数量" auto-complete="off" maxlength="50" show-word-limit style="width: 100%;"></el-input>-->
        </el-form-item>

        <el-form-item label="下单描述" prop="describee">
          <el-input v-model="orderForm.describee" placeholder="下单描述" auto-complete="off" maxlength="50" show-word-limit style="width: 100%;"></el-input>
        </el-form-item>

      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click.native="orderFormVisible = false">取消</el-button>
        <el-button type="primary" @click.native="buySubmit" >提交</el-button>
      </div>
    </el-dialog>

    <!--分页组件-->
    <el-pagination
            @size-change="handleSizeChange"
            @current-change="handleCurrentChange"
            :current-page="queryParams.current"
            :page-sizes="[8, 20, 50, 100, 300]"
            :page-size="queryParams.size"
            layout="total, sizes, prev, pager, next, jumper"
            :total="total"
            style="float:left;margin-top: 20px;">
    </el-pagination>

    <!-- [新增/修改]弹框界面 -->
    <el-drawer
            :title="addForm.id ? '修改' : '新增'"
            :visible.sync="open"
            direction="rtl"
            size="50%"
    >
      <div style="width: 80%;margin-left: 50px;">
        <el-form ref="addFormRef" :model="addForm" :rules="rules" label-width="120px">


              <el-form-item label="商品名称" prop="shopName" >
                <el-input v-model="addForm.shopName" placeholder="商品名称" auto-complete="off" maxlength="50" show-word-limit style="width: 100%;"></el-input>
              </el-form-item>

              <el-form-item label="价格" prop="price" >
                <el-input v-model="addForm.price" placeholder="价格" auto-complete="off" maxlength="50" show-word-limit style="width: 100%;"></el-input>
              </el-form-item>

              <el-form-item label="库存" prop="stock">
                <el-input v-model="addForm.stock" placeholder="库存" auto-complete="off" maxlength="50" show-word-limit style="width: 100%;"></el-input>
              </el-form-item>

              <el-form-item label="商品描述" prop="describee">
                <el-input v-model="addForm.describee" placeholder="商品描述" auto-complete="off" maxlength="50" show-word-limit style="width: 100%;"></el-input>
              </el-form-item>

        </el-form>
        <div slot="footer" class="dialog-footer"
             style="text-align: center;margin-bottom: 50px;margin-top: 20px;">
          <el-button type="primary" @click="submitForm">确 定</el-button>
          <el-button @click="open = false">取 消</el-button>
        </div>
      </div>
    </el-drawer>
  </div>
</template>

<script>
  export default {
    name: "SysUser",
    data() {
      return {
        max: 10,
        orderFormVisible:false,
        // 遮罩层
        loading: true,
        // 选中数组
        ids: [],
        // 非单个禁用
        single: true,
        // 非多个禁用
        multiple: true,
        // 总条数
        total: 0,
        // 参数表格数据
        tableDataList: [],
        // 是否显示弹出层
        open: false,
        // 日期范围
        dateRange: [],
        // 查询参数
        queryParams: {
          current: 1,
          size: 8,
          keyword: undefined,
        },
        // 表单参数
        addForm: {},
        orderForm: {
          shopName: '',
           price: 0.0,
         account: 1,
          describee: '',

        },
        // 表单校验
        rules: {
          id: [{ required: true, message: '主键ID不能为空', trigger: 'blur' }],
          shopName: [{ required: true, message: '商品名称不能为空', trigger: 'blur' }],
          price: [{ required: true, message: '价格不能为空', trigger: 'blur' }],
          stock: [{ required: true, message: '库存不能为空', trigger: 'blur' }],
          describee: [{ required: true, message: '商品描述不能为空', trigger: 'blur' }],
        },
      };
    },

    methods: {

      /** 获取列表数据方法 */
      getList() {
        this.loading = true;
        this.$http.post("/jiuzhe/shop/sysShop/pagelist", this.queryParams).then(result => {
          this.tableDataList = result.data.data.rows;
          this.total = result.data.data.total;
          this.loading = false;  //关闭加载圈
        });
      },

      /** 点击 搜索 按钮 */
      handleQuery() {
        this.queryParams.current = 1;
        this.getList();
      },

      /** 点击 重置 按钮 */
      resetQuery() {
        this.dateRange = [];
        if (this.$refs['queryForm']) {
          this.$refs['queryForm'].resetFields();
        }
        this.handleQuery();
      },

      /** 选择第几页事件 */
      handleCurrentChange(current) {
        this.queryParams.current = current;
        this.getList();
      },

      /** 选择每页显示条数 */
      handleSizeChange(size) {
        this.queryParams.size = size
        this.getList();
      },

      /** 点击 新增 按钮 */
      handleAdd() {
        this.addForm = Object.assign({}, {});
        this.open = true;
      },

      /** 多选框选中数据事件 */
      handleSelectionChange(selection) {
        this.ids = selection.map(item => item.id);//将数组里面的ID取出来形成ids集合
        this.single = selection.length != 1;
        this.multiple = !selection.length;
      },

      /** 取消多选框选中的记录 */
      cancelSelectionChange() {
        this.$refs.objectTable.clearSelection();
      },

      /** 点击 修改 按钮 */
      handleUpdate(row) {
        this.addForm = Object.assign({}, row);
        this.open = true;
      },
      /** 点击 购买 按钮 */
      handleBuy(row) {
        this.max=row.stock;
        this.orderForm = Object.assign({}, row);
        this.orderForm.describee="";
        this.orderFormVisible=true;

      },
      /** 购买提交按钮 */
      buySubmit(){
        //提交
        this.$http.post("/jiuzhe/shop/sysShop/buy", this.orderForm).then(res=>{
          var ajaxResult = res.data;
          if(ajaxResult.success){
            this.addFormVisible = false;
            this.$message({
              message: ajaxResult.message,
              type: 'success'
            });
          }else{
            this.$message({
              message: ajaxResult.message,
              type: 'error'
            });
          }
        });
      },
      /** 提交按钮 */
      submitForm: function () {
        this.$refs["addFormRef"].validate(valid => {
          if (valid) {
            if (this.addForm.id != undefined) {
              this.$http.post("/jiuzhe/shop/sysShop/update", this.addForm).then(result => {
                this.open = false;
                this.getList();
              });
            } else {
              this.$http.post("/jiuzhe/shop/sysShop/save", this.addForm).then(result => {
                this.open = false;
                this.getList();
              });
            }
          }
        });
      },

      /** 删除操作 */
      handleDelete(row) {
        if (row.id) {
          this.cancelSelectionChange();//取消复选框
          this.ids.push(row.id);
        }
        const tempIds = this.ids;
        let tishi = '';
        if (tempIds.length == 0) {
          tishi = '您确定要删除这条数据吗';
        } else {
          tishi = '您确定要删除这【' + tempIds.length + '】条数据吗？';
        }
        let param = {
          "ids": tempIds,
        }
        this.$confirm(tishi, '请确认', {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
          this.$http.post("/jiuzhe/shop/sysShop/batchDelete", param).then(result => {
            if (result.data.success) {
              this.$message({
                type: 'success',
                message: result.data.message
              });
            } else {
              this.$message({
                type: 'error',
                message: result.data.message
              });
            }
            this.getList();
          });
        }).catch(() => {
          console.log('已取消删除操作');
        });
      },
    },

    //计算表格高度
    computed: {
      tableMaxHeight() {
        return window.innerHeight - 280 + 'px'
      }
    },

    //钩子函数，进入页面就会加载的
    created() {
      this.getList();
    },
  };
</script>

<style scoped>
</style>